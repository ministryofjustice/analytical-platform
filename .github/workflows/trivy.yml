name: Trivy

on:
  schedule:
    - cron: "0 6 * * 1"

permissions: read-all

jobs:
  trivy:
    name: trivy
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
    - name: trivy
      id: terraform_static_analysis_trivy
      uses: aquasecurity/trivy-action@fbd16365eb88e12433951383f5e99bd901fc618f # v0.12.0
      with:
        scan-type: config
        scan-ref: HEAD
        ignore-unfixed: true
        output: 'trivy-results.sarif'
        format: sarif
        exit-code: '1'
        severity: CRITICAL,HIGH,LOW,MEDIUM
      continue-on-error: true

    - name: Upload SARIF results
      id: upload_trivy_results
      uses: actions/upload-artifact@a8a3f3ad30e3422c9c7b888a15615d19a852ae32 # v3.1.0
      with:
        name: SARIFT results
        path: trivy-results.sarif
        retention-days: 5

    - name: Upload to CodeQL
      id: upload_to_codeql
      uses: github/codeql-action/upload-sarif@cdcdbb579706841c47f7063dda365e292e5cad7a # v2.13.4
      with:
        sarif_file: trivy-results.sarif
