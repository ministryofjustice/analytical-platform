---
name: Container images - R Shiny

on:
  pull_request:
    branches:
      - main
    paths:
      - .github/workflows/container-images-rshiny.yml
      - container-images/rshiny/**
  push:
    branches:
      - main
    paths:
      - .github/workflows/container-images-rshiny.yml
      - container-images/rshiny/**

permissions: read-all

jobs:
  build:
    name: Build image
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        r: ["3.5.3", "3.6.3", "4.0.5", "4.1.3", "4.2.2"]
        shinyserver: ["0.0.4", "0.0.5", "0.0.6"]
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@24cb9080177205b6e8c946b17badbe402adc938f # v3.4.0

      - name: Install cosign
        id: install_cosign
        uses: sigstore/cosign-installer@c3667d99424e7e6047999fb6246c0da843953c65 # v3.0.1

      - name: Build image
        id: build
        uses: docker/build-push-action@3b5e8027fcad23fda98b2e3ac259d8d67585f671 # v4.0.0
        with:
          context: container-images/rshiny
          file: container-images/ubuntu/rshiny/Dockerfile
          push: false
          tags: rshiny:${{ matrix.r }}-${{ matrix.shinyserver }}
          build-args: |
            R_VERSION=${{ matrix.r }}
            AP_SHINY_SERVER_VERSION=${{ matrix.shinyserver }}

      # - name: Scan image (anchore)
      #   id: scan_image_anchore
      #   uses: anchore/scan-action@dafbc97d7259af88b61bd260f2fde565d0668a72 # v3.3.4
      #   with:
      #     image: rshiny:${{ matrix.r }}-${{ matrix.shinyserver }}
      #     severity-cutoff: critical

      # - name: Upload SARIF (anchore)
      #   if: always()
      #   id: upload_sarif_anchore
      #   uses: github/codeql-action/upload-sarif@168b99b3c22180941ae7dbdd5f5c9678ede476ba # v2.2.7
      #   with:
      #     sarif_file: ${{ steps.scan_image_anchore.outputs.sarif }}

      # - name: Scan SBOM
      #   id: scan_sbom
      #   uses: anchore/scan-action@dafbc97d7259af88b61bd260f2fde565d0668a72 # v3.3.4
      #   with:
      #     sbom: sbom-x86_64.spdx.json

      # - name: Publish SBOM
      #   id: publish_sbom
      #   uses: anchore/sbom-action/publish-sbom@07978da4bdb4faa726e52dfc6b1bed63d4b56479 # v0.13.3
      #   with:
      #     sbom-artifact-match: sbom-x86_64.spdx.json

      # - name: Login to Docker Hub
      #   if: github.ref == 'refs/heads/main'
      #   id: docker_login
      #   uses: docker/login-action@f4ef78c080cd8ba55a85445d5b36e214a81df20a # v2.1.0
      #   with:
      #     username: ${{ secrets.DOCKER_USERNAME }}
      #     password: ${{ secrets.DOCKER_PASSWORD }}

      # - name: Tag image
      #   if: github.ref == 'refs/heads/main'
      #   id: tag_image
      #   run: |
      #     docker tag \
      #       ${{ env.name }}:${{ env.version }}-amd64 \
      #       ministryofjustice/data-platform-${{ env.name }}:${{ env.version }}
      #     docker tag \
      #       ${{ env.name }}:${{ env.version }}-amd64 \
      #       ministryofjustice/data-platform-${{ env.name }}:latest

      # - name: Push image
      #   if: github.ref == 'refs/heads/main'
      #   id: push_image
      #   run: |
      #     docker push ministryofjustice/data-platform-${{ env.name }}:${{ env.version }}
      #     docker push ministryofjustice/data-platform-${{ env.name }}:latest

      # - name: Sign image
      #   if: github.ref == 'refs/heads/main'
      #   id: sign_image
      #   run: |
      #     cosign sign --yes ministryofjustice/data-platform-${{ env.name }}:${{ env.version }}
      #     cosign sign --yes ministryofjustice/data-platform-${{ env.name }}:latest
