---
  name: üì• Maintenance - Create JupyterLab Issue

  on:
    schedule:
      - cron: "0 8 1 * *" # UTC time: ‚ÄúAt 08:00 on first day-of-month‚Äù

  permissions: {}

  jobs:
    create-maintenance-issue:
      name: Create Maintenance Issue
      runs-on: ubuntu-latest
      permissions:
        issues: write
      steps:
        - name: Create Maintenance Issue
          id: create_maintenance_issue
          run: |
            if [[ "${CLOSE_PREVIOUS}" == true ]]; then
              previous_issue_number=$(gh issue list \
                --label "$LABELS" \
                --json number \
                --jq '.[0].number')
              if [[ -n $previous_issue_number ]]; then
                gh issue close "$previous_issue_number"
                gh issue unpin "$previous_issue_number"
              fi
            fi
            new_issue_url=$(gh issue create \
              --title "$TITLE" \
              --assignee "$ASSIGNEES" \
              --label "$LABELS" \
              --body "$BODY")
            if [[ $PINNED == true ]]; then
              gh issue pin "$new_issue_url"
            fi
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            GH_REPO: ${{ github.repository }}
            TITLE: üì• Maintenance - JML Report
            ASSIGNEES:
            LABELS: maintenance
            BODY: |
              ### User Story
              As a‚Ä¶ engineer on the Analytical Platform
              I need/want/expect to‚Ä¶ keep the JML report mechanism up to date
              So that‚Ä¶ security / best practice etc
              ### Definition of Done
              - [ ] Merge any open dependabot Pull Requests in the JML report [repository](https://github.com/ministryofjustice/analytical-platform-jml-report).
              - [ ] Create new [release](https://github.com/ministryofjustice/analytical-platform-jml-report/releases).
              - [ ] Update the [lambda function](https://github.com/ministryofjustice/analytical-platform/blob/main/terraform/aws/analytical-platform-data-production/joiners-movers-leavers/lambda-functions.tf) to consume the new release
            PINNED: false
            CLOSE_PREVIOUS: false
