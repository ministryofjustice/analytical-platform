{
  "openapi": "3.0.3",
  "info": {
    "title": "Data Product API",
    "description": "The Data Product API docs are based on the OpenAPI 3.0 specification.",
    "version": "0.0.1"
  },
  "externalDocs": {
    "description": "Find out more about Swagger",
    "url": "http://swagger.io"
  },
  "servers": [
    {
      "url": "https://our-cloudfront-mask-for-the-api/sandbox"
    },
    {
      "url": "https://our-cloudfront-mask-for-the-api/dev"
    }
  ],
  "paths": {
    "/upload_data": {
      "get": {
        "tags": [
          "upload_data"
        ],
        "summary": "Get a presigned url to upload some data to an existing data product.",
        "description": "Returns a presigned url to post data to.",
        "operationId": "uploadData",
        "parameters": [
          {
            "in": "query",
            "name": "database",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "in": "query",
            "name": "table",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "in": "query",
            "name": "contentMD5",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "in": "header",
            "name": "authorizationToken",
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "required": true
          }
        ],
        "responses": {
          "200": {
            "description": "successful operation",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/UploadDataResponse"
                }
              }
            }
          },
          "400": {
            "description": "Invalid Inputs supplied"
          },
          "404": {
            "description": "Data Product not found"
          }
        },
        "security": [
          {
            "api_key": []
          }
        ]
      }
    },
    "/get_glue_metadata": {
      "get": {
        "tags": [
          "get_glue_metadata"
        ],
        "summary": "Get metadata for a specified table in a specified Glue database",
        "description": "Returns a json object with all the metadata available for the specified database and table",
        "operationId": "getGlueMetadata",
        "parameters": [
          {
            "in": "query",
            "name": "database",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "in": "query",
            "name": "table",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "in": "header",
            "name": "authorizationToken",
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "required": true
          }
        ],
        "responses": {
          "200": {
            "description": "successful operation, response format https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/glue/client/get_table.html",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          },
          "400": {
            "description": "Invalid Inputs supplied"
          },
          "404": {
            "description": "Glue database and/or table not found"
          }
        }
      }
    },
    "/data-product/register": {
      "post": {
        "tags": [
          "register"
        ],
        "summary": "Register (metadata for) a new Data Product that you want to upload to the Data Platform.",
        "description": "Registers the first version of your Data Product (by submitting it's metadata)  and enables you to proceed with uploading data.",
        "operationId": "registerDataProduct",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/registerDataProduct"
              }
            }
          }
        },
        "parameters": [
          {
            "in": "header",
            "name": "authorizationToken",
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "required": true
          }
        ],
        "responses": {
          "201": {
            "description": "successfully created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "example": {}
                }
              }
            }
          },
          "400": {
            "description": "bad request",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "example": {
                    "error": {
                      "message": "Data product name is missing, it must be specified in the metadata  against the 'name' key"
                    }
                  }
                }
              }
            }
          },
          "405": {
            "description": "method not allowed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "example": {
                    "error": {
                      "message": "Sorry, GET isn't allowed."
                    }
                  }
                }
              }
            }
          },
          "409": {
            "description": "conflict",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "example": {
                    "error": {
                      "message": "Your data product already has a version 1 registered metadata."
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/data-product/{data-product-name}/table/{table-name}/schema": {
      "post": {
        "tags": [
          "schema"
        ],
        "summary": "Register a schema (blueprint of your table) for a new table in your Data Product that you want to upload to the Data Platform.",
        "description": "Registers the first version of your Data Product's table (by submitting its schema) and enables you to proceed with uploading data to it.",
        "operationId": "registerTableSchema",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/tableSchema"
              }
            }
          }
        },
        "parameters": [
          {
            "in": "path",
            "name": "data-product-name",
            "required": true,
            "example": "my_data_product",
            "schema": {
              "type": "string",
              "minimum": 1
            },
            "description": "The name of the data product you want to add a schema to. This needs to be a registered data product name."
          },
          {
            "in": "path",
            "name": "table-name",
            "required": true,
            "example": "table_1",
            "schema": {
              "type": "string",
              "minimum": 1,
              "maximum": 128
            },
            "description": "The name of the table to create schema for. Allows lowercase alphanumeric characters and \"_\"."
          },
          {
            "in": "header",
            "name": "authorizationToken",
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "required": true
          }
        ],
        "responses": {
          "200": {
            "description": "successfully created",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "example": {
                    "message": "Schema for {table-name} has been created in the {data-product-name} data product"
                  }
                }
              }
            }
          },
          "403": {
            "description": "bad request",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "example": {
                    "error": {
                      "message": "Data product name is missing, it must be specified in the metadata  against the 'name' key"
                    }
                  }
                }
              }
            }
          },
          "405": {
            "description": "method not allowed",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "example": {
                    "error": {
                      "message": "Sorry, GET isn't allowed."
                    }
                  }
                }
              }
            }
          }
        }
      },
      "get": {
        "tags": [
          "get_schema"
        ],
        "summary": "Get the latest schema for a table.",
        "description": "Returns a json object describing the table.",
        "operationId": "getTableSchema",
        "parameters": [
          {
            "in": "path",
            "name": "data-product-name",
            "required": true,
            "schema": {
              "type": "string",
              "minimum": 1
            },
            "description": "The name of the data product that contains the table schema. This needs to be a registered data product name."
          },
          {
            "in": "path",
            "name": "table-name",
            "required": true,
            "schema": {
              "type": "string",
              "minimum": 1,
              "maximum": 128
            },
            "description": "The name of the table with the schema. Allows lowercase alphanumeric characters and \"_\"."
          },
          {
            "in": "header",
            "name": "authorizationToken",
            "schema": {
              "type": "string",
              "format": "uuid"
            },
            "required": true
          }
        ],
        "responses": {
          "200": {
            "description": "successful operation, response format https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/glue/client/get_table.html",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/tableSchema"
                }
              }
            }
          },
          "404": {
            "description": "Data product or table schema not found"
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "tableSchema": {
        "required": [
          "schema"
        ],
        "type": "object",
        "properties": {
          "schema": {
            "$ref": "#/components/schemas/dataProductSchemaSchema"
          }
        }
      },
      "registerDataProduct": {
        "required": [
          "metadata"
        ],
        "type": "object",
        "properties": {
          "metadata": {
            "$ref": "#/components/schemas/dataProductMetadataSchema"
          }
        }
      },
      "dataProductMetadataSchema": {
        "$ref": "https://raw.githubusercontent.com/ministryofjustice/modernisation-platform-environments/main/terraform/environments/data-platform/data-product-metadata-json-schema/v1.1.0/moj_data_product_metadata_spec.json"
      },
      "dataProductSchemaSchema": {
        "$ref": "https://raw.githubusercontent.com/ministryofjustice/modernisation-platform-environments/main/terraform/environments/data-platform/data-product-table-schema-json-schema/v1.0.0/moj_data_product_table_spec.json"
      },
      "UploadDataRequest": {
        "required": [
          "database",
          "table",
          "contentMD5"
        ],
        "type": "object",
        "properties": {
          "database": {
            "type": "string",
            "example": "example_prison_data_product"
          },
          "table": {
            "type": "string",
            "example": "adjudications"
          },
          "contentMD5": {
            "type": "string",
            "example": "YojAHEZqfNk6B8zNmmLQhw=="
          }
        }
      },
      "URL": {
        "type": "object",
        "required": [
          "url",
          "fields"
        ],
        "properties": {
          "url": {
            "type": "string",
            "example": "https://data-platform-products.s3.amazonaws.com/"
          },
          "fields": {
            "$ref": "#/components/schemas/fields"
          }
        }
      },
      "UploadDataResponse": {
        "type": "object",
        "required": [
          "URL"
        ],
        "properties": {
          "URL": {
            "$ref": "#/components/schemas/URL"
          }
        }
      },
      "fields": {
        "type": "object",
        "properties": {
          "x-amz-server-side-encryption": {
            "type": "string",
            "example": "AES256"
          },
          "x-amz-acl": {
            "type": "string",
            "example": "bucket-owner-full-control"
          },
          "x-amz-date": {
            "type": "string",
            "example": "20230609T130209Z"
          },
          "Content-MD5": {
            "type": "string",
            "example": "YojAHEZqfNk6B8zNmmLQhw=="
          },
          "Content-Type": {
            "type": "string",
            "example": "binary/octet-stream"
          },
          "key": {
            "type": "string",
            "example": "curated_data/test/test/extraction_timestamp=20230609T130209Z/452b1aef-ca12-46ff-9dbf-42cbc80412f0"
          },
          "x-amz-algorithm": {
            "type": "string",
            "example": "AWS4-HMAC-SHA256"
          },
          "x-amz-credential": {
            "type": "string",
            "example": "AKIAIOSFODNN7EXAMPLE/20230609/eu-west-2/s3/aws4_request"
          },
          "x-amz-security-token": {
            "type": "string",
            "example": "IQo..."
          },
          "x-amz-signature": {
            "type": "string",
            "example": "54a..."
          },
          "policy": {
            "type": "string",
            "example": "eyJ..."
          }
        }
      }
    },
    "requestBodies": {
      "upload_data_request": {
        "description": "Request to upload data to the data platform.",
        "content": {
          "application/json": {
            "schema": {
              "$ref": "#/components/schemas/UploadDataRequest"
            }
          }
        }
      }
    },
    "securitySchemes": {
      "api_key": {
        "type": "apiKey",
        "name": "api_key",
        "in": "header"
      }
    }
  }
}
